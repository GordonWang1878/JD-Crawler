# 商品下架检测功能说明

## 🎯 功能概述

自动检测京东已下架的商品，并在 Excel 中标记为 `Unavailable`。

---

## 🔍 检测机制

### 触发条件
程序会检测页面中是否包含以下关键词：

- ✅ "该商品已下柜"
- ✅ "商品已下架"
- ✅ "该商品已下架"
- ✅ "抱歉，该商品已下柜"
- ✅ "欢迎挑选其他商品"
- ✅ "很抱歉，该商品已售馨或下架"

### 检测位置
在访问商品详情页后，立即检查页面源码（`page_source`）。

---

## 📊 处理结果

### 三种状态对比

| 状态 | Price | Promotion Price | 说明 |
|------|-------|----------------|------|
| **正常在售** | ¥199.00 | ¥199.00 | 有价格数据 |
| **已下架** | **Unavailable** | **Unavailable** | 商品已下柜 |
| **抓取失败** | N/A | N/A | 网络错误等 |

---

## 📺 终端显示示例

### 场景 1：正常商品
```bash
[1/10] https://item.jd.com/100140584252.html
  直接访问商品页...
  找到促销价: ¥67.91
  找到原价: ¥79.90
  ✓ 原价: ¥79.90, 促销价: ¥67.91
```

### 场景 2：已下架商品
```bash
[2/10] https://item.jd.com/999999999999.html
  直接访问商品页...
  ⚠️  商品已下架
```

### 场景 3：抓取失败
```bash
[3/10] https://item.jd.com/888888888888.html
  直接访问商品页...
  ✗ 未找到价格
```

---

## 📈 统计信息

### 完整统计
```
======================================================================
爬取完成！
======================================================================
  成功: 150          ← 正常获取价格
  已下架: 30         ← 检测到下架
  失败: 14           ← 其他错误
  总计: 194
  成功率: 77.3%
  下架率: 15.5%      ← 自动计算
```

### 统计规则
- **成功**: 成功获取价格的商品数
- **已下架**: 检测到下架关键词的商品数
- **失败**: 其他原因导致无法获取价格
- **成功率**: 成功数 / 总数
- **下架率**: 下架数 / 总数（只在有下架商品时显示）

---

## 📋 Excel 输出示例

| Runtime | URL | Price | Promotion Price | 备注 |
|---------|-----|-------|----------------|------|
| 2025-12-08 15:00 | item.jd.com/111.html | ¥199.00 | ¥199.00 | 正常 |
| 2025-12-08 15:01 | item.jd.com/222.html | **Unavailable** | **Unavailable** | 已下架 |
| 2025-12-08 15:02 | item.jd.com/333.html | ¥299.00 | ¥199.00 | 促销中 |
| 2025-12-08 15:03 | item.jd.com/444.html | N/A | N/A | 抓取失败 |

---

## 🔬 技术实现

### 检测流程

```
访问商品页面
    ↓
等待页面加载 (4秒)
    ↓
获取页面源码
    ↓
检查是否包含下架关键词
    ↓
    ├─ 是 → 返回 {'original': 'unavailable', 'promo': 'unavailable'}
    │         ↓
    │      写入 'Unavailable' 到 Excel
    │         ↓
    │      unavailable_count += 1
    │
    └─ 否 → 继续提取价格
            ↓
         正常流程
```

### 代码位置

**检测逻辑** (`jd_crawler_via_search.py:180-194`):
```python
# 检查商品是否已下架
page_text = self.driver.page_source
unavailable_keywords = [
    "该商品已下柜",
    "商品已下架",
    # ...更多关键词
]

for keyword in unavailable_keywords:
    if keyword in page_text:
        print(f"  ⚠️  商品已下架")
        return {'original': 'unavailable', 'promo': 'unavailable'}
```

**处理逻辑** (`main_batch.py:167-177`):
```python
# 检查商品是否下架
if original == 'unavailable' and promo == 'unavailable':
    print(f"  ⚠️  商品已下架")
    results.append({
        'Runtime': runtime,
        'URL': url,
        'Price': 'Unavailable',
        'Promotion Price': 'Unavailable'
    })
    unavailable_count += 1
    continue
```

---

## 💡 使用建议

### 1. 定期监控
通过定期运行爬虫，可以：
- 追踪商品上下架状态
- 识别长期缺货商品
- 更新商品目录

### 2. Excel 筛选
在 Excel 中筛选下架商品：
```
筛选条件：Price = "Unavailable"
```

### 3. 数据分析
在 Excel 中统计下架比例：
```excel
=COUNTIF(C:C,"Unavailable")/COUNTA(C:C)
```

### 4. 清理 URL 列表
可以考虑从 URL 列表中移除长期下架的商品：
1. 运行程序
2. 筛选 `Unavailable` 商品
3. 检查是否长期下架
4. 从输入文件中删除这些 URL

---

## ⚠️ 注意事项

### 可能的误报

1. **网络加载问题**
   - 页面加载不完整可能误判
   - 解决：程序已设置 4 秒等待时间

2. **页面结构变化**
   - 京东可能更改提示文案
   - 解决：已包含多个常见关键词

3. **临时缺货 vs 永久下架**
   - 无法区分两者
   - 建议：多次运行确认

### 性能影响

- **增加处理时间**: 约 0.1 秒/商品（检查页面源码）
- **内存占用**: 轻微增加（存储页面源码）
- **整体影响**: 可以忽略不计

---

## 🎉 总结

### 优势
- ✅ 自动识别下架商品
- ✅ 区别于普通抓取失败
- ✅ 提供独立统计数据
- ✅ 方便数据分析和清理

### 状态对照表

| 显示值 | 含义 | 计入统计 |
|--------|------|---------|
| ¥199.00 | 正常价格 | 成功 |
| Unavailable | 商品已下架 | 已下架 |
| N/A | 抓取失败 | 失败 |
