{% extends "base.html" %}

{% block title %}仪表盘 - JD价格爬虫系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="bi bi-speedometer2"></i> 仪表盘</h2>
        <p class="text-muted">实时监控爬虫运行状态</p>
    </div>
</div>

<!-- 统计卡片 -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card stat-card success">
            <div class="card-body">
                <div class="stat-label">今日成功</div>
                <div class="stat-value" id="today-success">-</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card warning">
            <div class="card-body">
                <div class="stat-label">今日失败</div>
                <div class="stat-value" id="today-failed">-</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card info">
            <div class="card-body">
                <div class="stat-label">成功率</div>
                <div class="stat-value" id="success-rate">-</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="stat-label">总数</div>
                <div class="stat-value" id="total-count">-</div>
            </div>
        </div>
    </div>
</div>

<!-- 快速操作 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-lightning-charge"></i> 快速操作
            </div>
            <div class="card-body">
                <div class="d-grid gap-2 d-md-flex">
                    <a href="/batch" class="btn btn-primary">
                        <i class="bi bi-play-circle"></i> 开始新批量爬取
                    </a>
                    <a href="/history" class="btn btn-outline-secondary">
                        <i class="bi bi-clock-history"></i> 查看历史记录
                    </a>
                    <a href="/single" class="btn btn-outline-info">
                        <i class="bi bi-search"></i> 测试单个商品
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 最近日志 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-terminal"></i> 最近日志</span>
                <a href="/logs" class="btn btn-sm btn-outline-primary">查看全部</a>
            </div>
            <div class="card-body">
                <div class="log-container" style="max-height: 300px;">
                    <div id="log-entries-dashboard"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 加载统计数据
function loadStats() {
    apiRequest('/api/stats')
        .then(data => {
            document.getElementById('today-success').textContent = data.today_success;
            document.getElementById('today-failed').textContent = data.today_failed;
            document.getElementById('success-rate').textContent = data.success_rate + '%';
            document.getElementById('total-count').textContent = data.total_count;
        })
        .catch(err => {
            console.error('Failed to load stats:', err);
        });
}

// 加载最近日志
function loadRecentLogs() {
    apiRequest('/api/logs?limit=20')
        .then(data => {
            const logContainer = document.getElementById('log-entries-dashboard');
            logContainer.innerHTML = '';
            data.logs.forEach(log => {
                appendLog(log);
            });
        })
        .catch(err => {
            console.error('Failed to load logs:', err);
        });
}

// 重写appendLog以支持dashboard
function appendLog(data) {
    const logContainer = document.getElementById('log-entries-dashboard');
    if (!logContainer) return;

    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';

    const levelClass = `log-level-${data.level}`;
    const timestamp = `<span class="log-timestamp">[${data.timestamp}]</span>`;
    const level = `<span class="${levelClass}">[${data.level}]</span>`;
    const message = `<span>${data.message}</span>`;

    logEntry.innerHTML = `${timestamp} ${level} ${message}`;
    logContainer.insertBefore(logEntry, logContainer.firstChild);

    while (logContainer.children.length > 20) {
        logContainer.removeChild(logContainer.lastChild);
    }
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadRecentLogs();

    // 每30秒刷新一次统计
    setInterval(loadStats, 30000);
});
</script>
{% endblock %}
