{% extends "base.html" %}

{% block title %}历史记录 - JD价格爬虫系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="bi bi-clock-history"></i> 历史记录</h2>
        <p class="text-muted">查看所有批量爬取的历史记录</p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-ul"></i> 批次列表
            </div>
            <div class="card-body">
                <div id="history-list">
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function loadHistory() {
    apiRequest('/api/history')
    .then(data => {
        const listDiv = document.getElementById('history-list');

        if (data.batches.length === 0) {
            listDiv.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <p>暂无历史记录</p>
                </div>
            `;
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-hover">';
        html += `
            <thead>
                <tr>
                    <th>批次时间</th>
                    <th>总数</th>
                    <th>成功</th>
                    <th>失败</th>
                    <th>下架</th>
                    <th>用时</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
        `;

        data.batches.forEach(batch => {
            const successRate = (batch.success / batch.total * 100).toFixed(1);
            html += `
                <tr>
                    <td>${batch.batch_time}</td>
                    <td>${batch.total}</td>
                    <td><span class="text-success">${batch.success}</span></td>
                    <td><span class="text-danger">${batch.failed}</span></td>
                    <td><span class="text-warning">${batch.unavailable}</span></td>
                    <td>${batch.duration}秒</td>
                    <td><span class="badge bg-info">${batch.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewBatch(${batch.id})">
                            <i class="bi bi-eye"></i> 查看
                        </button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        listDiv.innerHTML = html;
    })
    .catch(err => {
        document.getElementById('history-list').innerHTML = `
            <div class="alert alert-danger">加载失败: ${err}</div>
        `;
    });
}

function viewBatch(batchId) {
    window.location.href = `/batch/${batchId}`;
}

document.addEventListener('DOMContentLoaded', function() {
    loadHistory();
});
</script>
{% endblock %}
